<!DOCTYPE html>
<meta charset="utf-8">
<style>
.axis text {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.hexagon {
  fill: none;
  stroke: #000;
  stroke-width: .5px;
}

#planet-tooltip {
  position: absolute;
  text-align: center;
	left: 0px;
	top: 15%;
  width: 40%;
  height: 80%;
  padding: 2px;
  font: 12px sans-serif;
  background: lightsteelblue;
  border: 0px;
  border-radius: 8px;
	opacity: 0;
  pointer-events: none;
}

#planet-tooltip-menu {
  width: 25%;
  float: left;
  padding: 15px;
  /*border: 1px solid red;*/
}

#planet-tooltip-main {
  width: 100%;
  float: left;
  padding: 15px;
  /*border: 1px solid red;*/
}

#system-tooltip-main {
  position: absolute;
  text-align: center;
  left: 40%;
  top: 15%;
  width: 40%;
  height: 80%;
  padding: 2px;
  font: 12px sans-serif;
  background: lightsteelblue;
  border: 0px;
  border-radius: 8px;
  opacity: 0;
  pointer-events: none;
}

#planet-build-main, #spaceport-build-main, #satellite-build-main {
  position: absolute;
  text-align: center;
  left: 50%;
  top: 25%;
  width: 20%;
  height: auto;
  min-height: 30% !important;
  padding: 2px;
  font: 12px sans-serif;
  background: lightsteelblue;
  border: 0px;
  border-radius: 8px;
  opacity: 0;
  pointer-events: none;
}

#system-action-menu {
  position: relative;
  text-align: center;
  left: 0%;
  top: 0%;
  width: 10%;
  height: 30%;
  padding: 2px;
  font: 12px sans-serif;
  background: red;
  border: 0px;
  border-radius: 8px;
  opacity: 0;
  pointer-events: none;
}

#system-tooltip-header {

}

#system-tooltip-starmap {

}

#fleet-tooltip-main {
  position: absolute;
  text-align: center;
  left: 10%;
  top: 65%;
  width: auto;
  height: auto;
  min-width: 20% !important;
  min-height: 30% !important;
  padding: 2px;
  font: 12px sans-serif;
  background: lightsteelblue;
  border: 0px;
  border-radius: 8px;
  opacity: 0;
  pointer-events: none;
}

.col-md-3 {

}

.intro { height: 100px; width: 300px; }

#player-hud {
  position: absolute;
  text-align: center;
	top: 10%;
  width: 80%;
	left: 10%;
  height: 10%;
  padding: 2px;
  font: 12px sans-serif;
  background: lightsteelblue;
  border: 0px;
  border-radius: 8px;
  /*pointer-events: none;*/
}

#tutorial {
  position: absolute;
  text-align: center;
  top: 20%;
  width: 60%;
  left: 20%;
  height: 5%;
  padding: 2px;
  font: 12px sans-serif;
  background: lightsteelblue;
  border: 0px;
  border-radius: 8px;
  opacity: 1;
  pointer-events: none;
}

#system-tutorial {
  position: absolute;
  text-align: center;
  top: 10%;
  width: 60%;
  left: 20%;
  height: 5%;
  padding: 2px;
  font: 12px sans-serif;
  background: rgba(255, 255, 255, 0);
  border: 0px;
  border-radius: 8px;
  opacity: 1;
  pointer-events: none;
}

.tint {
  position: relative;
  float: left;
  margin-right: 20px;
  margin-bottom: 20px;
  cursor: pointer;
  box-shadow: rgba(0,0,0,.2) 3px 5px 5px;
}

.tint:before {
  content: "";
  display: block;
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(0,255,255, 0.5);
  transition: all .3s linear;
}

</style>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../favicon.ico">

    <title>Dante Tam</title>

    <!-- Bootstrap core CSS -->
    <link href="../../../dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="../../../assets/css/ie10-viewport-bug-workaround.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="index.css" rel="stylesheet">
		<link href="default.css" rel="stylesheet">

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="../../../assets/js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

		<!--<script src="d3.v3.min.js"></script>-->
		<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
		<script src="d3.hexbin.min.js"></script>
		<script src="https://d3js.org/d3-random.v1.min.js"></script>
    <script src="https://d3js.org/d3-timer.v1.min.js"></script>
    <script src="https://d3js.org/d3-array.v1.min.js"></script>
    <script src="https://d3js.org/d3-collection.v1.min.js"></script>

  </head>

  <body>
    <nav class="navbar navbar-intro navbar-fixed-top navie">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
          </button>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav navbar-intro">
						<li class="dropdown">
							<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">@dantetam<span class="caret"></span></a>
							<ul class="dropdown-menu">
								<li class="dropdown-header">Professional</li>
								<li><a href="https://github.com/dantetam" target="_blank">GitHub</a></li>
								<li><a href="mailto:dante.tam1@gmail.com">E-mail</a></li>
								<li role="separator" class="divider"></li>
								<li class="dropdown-header">Personal</li>
								<li><a href="#"></a></li>
								<li><a href="#"></a></li>
							</ul>
						</li>
            <li><a href="../../../index.html">Home</a></li>
            <li><a href="../../projects.html">Personal Projects</a></li>
						<li><a href="../../writings.html">Writings</a></li>
						<li class="dropdown">
							<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Technical Drawings<span class="caret"></span></a>
							<ul class="dropdown-menu">
								<li class="dropdown-header">Design</li>
								<li><a href="../../opstrykon_gdd.pdf">Game Design Document</a></li>
								<li><a href="../../drawings.html">Architecture</a></li>
								<li role="separator" class="divider"></li>
								<li class="dropdown-header">Nav header</li>
								<li><a href="#"></a></li>
								<li><a href="#"></a></li>
							</ul>
						</li>
						<li><a href="../../courses.html">Courses</a></li>
						<li><a href="../../resume.pdf">Resume</a></li>
						<li class="dropdown active">
							<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Experiments<span class="caret"></span></a>
							<ul class="dropdown-menu">
								<li class="dropdown-header">Design and Data</li>
								<li><a href="../../experiments/resume/index.html">Interactive Resume (d3.js)</a></li>
								<li><a href="../../experiments/testglwebsite/src/index.html">Graphics (WebGL)</a></li>
								<li class="active"><a href="../../experiments/datavisual/index.html">Data Visualization (d3.js)</a></li>
								<li role="separator" class="divider"></li>
								<li><a href="#"></a></li>
								<li><a href="#"></a></li>
							</ul>
						</li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">

      <div class="intro">

      </div>

    </div><!-- /.container -->

		<div id="player-hud">
			<p>
				Minerals<img src="./minerals.png" alt="Minerals" width="50" height="50" style="max-height:50px; max-width:50px; width:10%;"/>150 / +0&emsp;&emsp;&emsp;
				Energy&emsp;<img src="./energy.png" alt="Energy" width="50" height="50" style="max-height:50px; max-width:50px; width:10%;"/>&emsp;50 / +0&emsp;&emsp;&emsp;
				Planets&emsp;<img src="./planets.png" alt="Planets" width="50" height="50" style="max-height:50px; max-width:50px; width:10%;"/>&emsp;1/5&emsp;&emsp;&emsp;
        <button type="button" onclick="javascript:setGameSpeed(&quot;Paused&quot;)">Pause</button>
        <button type="button" onclick="javascript:setGameSpeed(&quot;Slow&quot;)">Slow</button>
        <button type="button" onclick="javascript:setGameSpeed(&quot;Fast&quot;)">Fast</button>
        <button type="button" onclick="javascript:setGameSpeed(&quot;Fastest&quot;)">Fastest</button>
        <div id="player-hud-time"></div>
      </p>
		</div>
    <div id="tutorial">
			<p>
				Click on the hexes to learn about the planets in those sectors!
			</p>
		</div>

		<div id="planet-tooltip">

			<div id="planet-tooltip-header">
				<h1>Test</h1>
			</div>

			<!--<div id="planet-tooltip-menu">
				<ul>
					<li>Test</li>
					<li>Test</li>
					<li>Test</li>
					<li>Test</li>
				</ul>
			</div>-->

			<div id="planet-tooltip-main">
				<div class="row">
					<div id="planet-tooltip-tile0" class="col-md-3">Test Text</div>
					<div id="planet-tooltip-tile1" class="col-md-3">col-md-3</div>
					<div id="planet-tooltip-tile2" class="col-md-3">col-md-3</div>
					<div id="planet-tooltip-tile3" class="col-md-3">col-md-3</div>
				</div>
				<div class="row">
					<div id="planet-tooltip-tile4" class="col-md-3">Test Text</div>
					<div id="planet-tooltip-tile5" class="col-md-3">col-md-3</div>
					<div id="planet-tooltip-tile6" class="col-md-3">col-md-3</div>
					<div id="planet-tooltip-tile7" class="col-md-3">col-md-3</div>
				</div>
				<div class="row">
					<div id="planet-tooltip-tile8" class="col-md-3">Test Text</div>
					<div id="planet-tooltip-tile9" class="col-md-3">col-md-3</div>
					<div id="planet-tooltip-tile10" class="col-md-3">col-md-3</div>
					<div id="planet-tooltip-tile11" class="col-md-3">col-md-3</div>
				</div>
				<div class="row">
					<div id="planet-tooltip-tile12" class="col-md-3">Test Text</div>
					<div id="planet-tooltip-tile13" class="col-md-3">col-md-3</div>
					<div id="planet-tooltip-tile14" class="col-md-3">col-md-3</div>
					<div id="planet-tooltip-tile15" class="col-md-3">col-md-3</div>
				</div>
				<div class="row">
					<div id="planet-tooltip-tile16" class="col-md-3">Test Text</div>
					<div id="planet-tooltip-tile17" class="col-md-3">col-md-3</div>
					<div id="planet-tooltip-tile18" class="col-md-3">col-md-3</div>
					<div id="planet-tooltip-tile19" class="col-md-3">col-md-3</div>
				</div>
			</div>

		</div>

    <div id="system-tooltip-main">

      <div id="system-tooltip-header">
				<h1>Test</h1>
			</div>

      <div id="system-action-menu">

      </div>

      <div id="system-tutorial">
        <p>
          Click on the planets to look at their resources and other information!
        </p>
      </div>

      <div id="system-tooltip-starmap">

      </div>

    </div>

    <div id="planet-build-main">
      <div id="planet-build-header">
				<h1>Test</h1>
			</div>
      <div id="planet-build-options">

      </div>
    </div>

    <div id="spaceport-build-main">
      <div id="spaceport-build-header">
				<h1>Test</h1>
			</div>
      <div id="spaceport-build-options">

      </div>
    </div>

    <div id="satellite-build-main">
      <div id="satellite-build-header">
				<h1>Test</h1>
			</div>
      <div id="satellite-build-options">

      </div>
    </div>

    <div id="fleet-tooltip-main">
      <div id="fleet-tooltip-header">
				<h1>Test</h1>
			</div>

      <div id="fleet-tooltip-options">

      </div>
    </div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery.min.js"><\/script>')</script>
    <script src="../../../dist/js/bootstrap.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../../../assets/js/ie10-viewport-bug-workaround.js"></script>

		<script>

		var margin = {top: 20, right: 100, bottom: 30, left: 100},
				width = $(window).width() - margin.left - margin.right,
				height = $(window).height() - margin.top - margin.bottom;

		var randomX = d3.random.normal(width / 2, 80),
				randomY = d3.random.normal(height / 2, 80);
    /*var randomX = d3.randomUniform(width*0.25, width*0.75),
        randomY = d3.randomUniform(height*0.25, height*0.75);*/

    var frames = 0, days = 0, currentDate = new Date("2100-01-01");

		var points = [],
        stars = [],
				planets = [],
        sectors = [],
				civilizations = [];
				//points = d3.range(2000).map(function() { return [randomX(), randomY()]; });

		var civColors = ["red", "blue", "steelblue", "violet", "green"];

    var gameMode = "Paused";
    var constructionOrders = [], unitOrders = [], satelliteOrders = [], moveWithinSectorOrders = [], moveToSectorOrders = [], shipRecoverFTL = [];

    var currentSectorSelected = null;
    var currentPlanetSelected = null;
    var currentFleetSelected = null;
    var currentSpaceportSelected = null;

		var planetData = [];
    var removePlanetNames = [];
    //var removePlanetNames = ["Kepler", "HD "];
		d3.csv("./planet-names.csv", function(data) {
      for (var i = 0; i < data.length; i++) {
				//console.log();
        var planetName = data[i]["pl_hostname"];
        var valid = true;
        for (var j = 0; j < removePlanetNames.length; j++) {
          valid = valid && !planetName.includes(removePlanetNames[j]);
        }
        if (valid) {
  				planetData.push(data[i]);
        }
			}
			namePlanets();
		});

    var starData = [];
    var removeStarNames = ["Hip", "BD+", "BD-"];
    var starSpectralClasses = ["O", "B", "A", "F", "G", "K", "M"];
    function determineStarType(stringy) {
      for (var i = 0; i < stringy.length; i++) {
        for (var j = 0; j < starSpectralClasses.length; j++) {
          if (stringy[i] === starSpectralClasses[j]) {
            return stringy[i];
          }
        }
      }
      return "U";
    }
    d3.csv("./stars-cut.csv", function(data) {
			//console.log(data);
			for (var i = 0; i < data.length; i++) {
				//console.log();
        var starName = data[i]["Display Name"];
        var valid = true;
        for (var j = 0; j < removeStarNames.length; j++) {
          valid = valid && !starName.includes(removeStarNames[j]);
        }
        //console.log(data[i]["Spectral Class"][0]);
        data[i]["Star Type"] = determineStarType(data[i]["Spectral Class"]);
        if (valid) {
  				starData.push(data[i]);
        }
			}
			nameStars();
		});

    var smallBodyData = [];
    d3.csv("./small-body.csv", function(data) {
			//console.log(data);
			for (var i = 0; i < data.length; i++) {
				//console.log();
        var smallBodyName = data[i]["name"];
        if (smallBodyName.length < 10) {
          if (smallBodyName !== null && smallBodyName !== "") {
    				smallBodyData.push(data[i]);
          }
        }
			}
			nameAsteroids();
		});

		var small = d3.random.normal(7, 1.5),
				medium = d3.random.normal(12, 1.5),
				large = d3.random.normal(16, 3);

		var maxTiles = 20;

    //TODO: Convert data into CSV format
    var tileImprovements = [
      {name: "Primitive Farm", output: [0,0,1,0,0,0], buildTime: 70, cost: [50,0,25,0,0,0], maintenance: [0,0,0,0,0,0], techLevelRestrictMin: 0, techLevelRestrictMax: 3, biomeRestrict: "Arable", terrainRestrict: "Land", buildingRestrict: null},
      {name: "Primitive City", output: [1,1,1,1,1,1], buildTime: 70, cost: [50,0,25,0,0,0], maintenance: [0,-1,0,0,0,0], techLevelRestrictMin: 0, techLevelRestrictMax: 3, biomeRestrict: "NotToxic", terrainRestrict: "Land", buildingRestrict: null},
			{name: "Mine I", output: [2,0,0,0,0,0], buildTime: 70, cost: [60,0,0,0,0,0], maintenance: [0,-1,0,0,0,0], techLevelRestrictMin: 4, techLevelRestrictMax: 99, biomeRestrict: "NotToxic", terrainRestrict: "Land", buildingRestrict: null},
      {name: "Mine II", output: [3,0,0,0,0,0], buildTime: 120, cost: [90,0,0,0,0,0], maintenance: [0,-2,0,0,0,0], techLevelRestrictMin: 4, techLevelRestrictMax: 99, biomeRestrict: "NotToxic", terrainRestrict: "Land", buildingRestrict: "Mine I"},
      {name: "Mine III", output: [4,0,0,0,0,0], buildTime: 200, cost: [120,0,0,0,0,0], maintenance: [0,-3,0,0,0,0], techLevelRestrictMin: 4, techLevelRestrictMax: 99, biomeRestrict: "NotToxic", terrainRestrict: "Land", buildingRestrict: "Mine II"},
			{name: "Platform I", output: [1,1,0,0,0,0], buildTime: 100, cost: [100,50,0,0,0,0], maintenance: [0,0,0,0,0,0], techLevelRestrictMin: 4, techLevelRestrictMax: 99, biomeRestrict: "NotToxic", terrainRestrict: "Sea", buildingRestrict: null},
      {name: "Platform II", output: [1,2,0,0,0,0], buildTime: 160, cost: [150,50,0,0,0,0], maintenance: [0,0,0,0,0,0], techLevelRestrictMin: 4, techLevelRestrictMax: 99, biomeRestrict: "NotToxic", terrainRestrict: "Sea", buildingRestrict: "Platform I"},
      {name: "Platform III", output: [1,3,0,0,0,0], buildTime: 250, cost: [200,50,0,0,0,0], maintenance: [0,0,0,0,0,0], techLevelRestrictMin: 4, techLevelRestrictMax: 99, biomeRestrict: "NotToxic", terrainRestrict: "Sea", buildingRestrict: "Platform II"},
			{name: "Hydroponic Farm I", output: [0,0,2,0,0,0], buildTime: 70, cost: [50,0,25,0,0,0], maintenance: [0,-1,0,0,0,0], techLevelRestrictMin: 4, techLevelRestrictMax: 99, biomeRestrict: "Arable", terrainRestrict: "Land", buildingRestrict: null},
      {name: "Hydroponic Farm II", output: [0,0,2,0,0,0], buildTime: 120, cost: [100,0,25,0,0,0], maintenance: [0,-2,0,0,0,0], techLevelRestrictMin: 4, techLevelRestrictMax: 99, biomeRestrict: "Arable", terrainRestrict: "Land", buildingRestrict: "Hydroponic Farm I"},
      {name: "Hydroponic Farm III", output: [0,0,2,0,0,0], buildTime: 200, cost: [150,0,25,0,0,0], maintenance: [0,-3,0,0,0,0], techLevelRestrictMin: 4, techLevelRestrictMax: 99, biomeRestrict: "Arable", terrainRestrict: "Land", buildingRestrict: "Hydroponic Farm II"},
			{name: "Power Plant I", output: [0,2,0,0,0,0], buildTime: 70, cost: [50,50,0,0,0,0], maintenance: [0,0,-1,0,0,0], techLevelRestrictMin: 4, techLevelRestrictMax: 99, biomeRestrict: "NotToxic", terrainRestrict: "Land", buildingRestrict: null},
      {name: "Power Plant II", output: [0,3,0,0,0,0], buildTime: 120, cost: [100,50,0,0,0,0], maintenance: [-1,0,-1,0,0,0], techLevelRestrictMin: 4, techLevelRestrictMax: 99, biomeRestrict: "NotToxic", terrainRestrict: "Land", buildingRestrict: "Power Plant I"},
      {name: "Power Plant III", output: [0,4,0,0,0,0], buildTime: 200, cost: [150,50,0,0,0,0], maintenance: [-2,0,-1,0,0,0], techLevelRestrictMin: 4, techLevelRestrictMax: 99, biomeRestrict: "NotToxic", terrainRestrict: "Land", buildingRestrict: "Power Plant II"},
      {name: "Lab I", output: [0,0,0,1,1,1], buildTime: 200, cost: [150,50,0,0,0,0], maintenance: [-2,0,-1,0,0,0], techLevelRestrictMin: 4, techLevelRestrictMax: 99, biomeRestrict: "NotToxic", terrainRestrict: "Land", buildingRestrict: "Power Plant II"},
			{name: "Colony", output: [0,0,3,3,3,3], buildTime: 250, cost: [250,0,50,0,0,0], maintenance: [-3,-3,0,0,0,0], techLevelRestrictMin: 4, techLevelRestrictMax: 99, biomeRestrict: "NotToxic", terrainRestrict: "Land", buildingRestrict: null}
		];

    var planetSatellites = [
      {name: "Spaceport", planet: null, output: [0,0,0,1,1,1], buildTime: 400, cost: [250,0,0,0,0,0], maintenance: [0,-3,-2,0,0,0], biomeRestrict: "NotAsteroid", starRestrict: null, orders: []},
      {name: "Mining Station", planet: null, output: [2,0,0,0,0,0], buildTime: 120, cost: [90,0,0,0,0,0], maintenance: [0,-1,0,0,0,0], biomeRestrict: null, starRestrict: null, orders: []},
      {name: "Star Station", planet: null, output: [0,2,0,0,0,0], buildTime: 120, cost: [90,0,0,0,0,0], maintenance: [0,0,0,0,0,0], biomeRestrict: null, starRestrict: null, orders: []},
      {name: "Research Station", planet: null, output: [0,0,0,1,1,1], buildTime: 120, cost: [90,0,0,0,0,0], maintenance: [0,-1,0,0,0,0], biomeRestrict: null, starRestrict: null, orders: []}
    ];

    var shipTypes = {};
    shipTypes["Satellite"] = {name: "Satellite", strength: 10, maxHealth: 30, speed: 0, buildTime: 250, cost: [250,0,0,0,0,0], maintenance: [0,0,0,0,0,0], levelRestrict: 0, ftl: 0, maxFtl: 0};
    shipTypes["Explorer"] = {name: "Explorer", strength: 30, maxHealth: 50, speed: 2, buildTime: 100, cost: [100,0,0,0,0,0], maintenance: [0,-1,0,0,0,0], levelRestrict: 1, ftl: 30, maxFtl: 30, action: "Survey"};
    shipTypes["Constructor"] = {name: "Constructor", strength: 40, maxHealth: 50, speed: 2, buildTime: 100, cost: [100,0,0,0,0,0], maintenance: [0,-1,0,0,0,0], levelRestrict: 1, ftl: 30, maxFtl: 30, action: "Build"};
    shipTypes["Colony Flagship"] = {name: "Colony Flagship", strength: 90, speed: 1, maxHealth: 100, buildTime: 250, cost: [250,0,40,0,0,0], maintenance: [0,-1,0,0,0,0], levelRestrict: 1, ftl: 30, maxFtl: 30, action: "Colonize"};
    shipTypes["Cruiser"] = {name: "Cruiser", strength: 50, maxHealth: 30, speed: 1, buildTime: 70, cost: [60,0,0,0,0,0], maintenance: [0,-1,0,0,0,0], levelRestrict: 1, ftl: 30, maxFtl: 30};
    shipTypes["Destroyer"] = {name: "Destroyer", strength: 150, maxHealth: 50, speed: 1, buildTime: 150, cost: [150,0,0,0,0,0], maintenance: [0,-2,0,0,0,0], levelRestrict: 2, ftl: 30, maxFtl: 30};
    shipTypes["Battleship"] = {name: "Battleship", strength: 350, maxHealth: 120, speed: 1, buildTime: 350, cost: [400,0,0,0,0,0], maintenance: [0,-3,0,0,0,0], levelRestrict: 3, ftl: 30, maxFtl: 30};

    function createFleet(sector, name, position, owner, shipNames) {
      var ships = [];
      for (var i = 0; i < shipNames.length; i++) {
        //console.log(shipNames[i] + " " + shipTypes[shipNames[i]] + " " + shipTypes["Destroyer"]);
        ships.push({
          name: shipNames[i],
          owner: owner,
          strength: shipTypes[shipNames[i]].strength,
          health: shipTypes[shipNames[i]].maxHealth,
          maxHealth: shipTypes[shipNames[i]].maxHealth
        });
      }
      var theId = Object.keys(owner.fleets).length;
      var speed = ships[0].speed;
      for (var i = 0; i < ships.length; i++) {
        if (ships[i].speed < speed) {
          speed = ships[i].speed;
        }
      }
      var fleet = {
        sector: sector,
        position: position,
        owner: owner,
        name: name,
        ships: ships,
        id: theId,
        orders: [],
        speed: speed
      }
      owner.fleets["Fleet" + theId] = fleet;
      for (var i = 0; i < fleet.ships.length; i++) {
        fleet.ships[i].owner = owner;
      }
      moveFleet(fleet, sector, position);
      return fleet;
    }

    function moveFleet(fleet, destSector, destPosition) {
      if (fleet.sector !== null) {
        var indexOfFleet = fleet.sector.fleets.indexOf(fleet);
        if (indexOfFleet !== -1) {
          fleet.sector.fleets.splice(indexOfFleet, 1);
        }
      }
      fleet.sector = destSector;
      fleet.position = destPosition;
      if (destSector !== null) {
        destSector.fleets.push(fleet);
      }
    }

    function removeFleet(fleet) {
      if (fleet.sector !== null) {
        var indexOfFleet = fleet.sector.fleets.indexOf(fleet);
        if (indexOfFleet !== -1) {
          fleet.sector.fleets.splice(indexOfFleet, 1);
        }
      }
      fleet.ships = [];
      fleet.sector = null;
    }

    /*
    Input arrayOfFleets in the form of an array containing multiple sets of fleets, e.g.
    [
      [civ1 fleet1, civ1 fleet2, ..., civ1 fleetN1],
      [civ2 fleet1, civ2 fleet2, ..., civ2 fleetN2],
      ...
      [civN fleet1, civN fleet2, ..., civN fleetN3],
    ]
    where each array is a different faction in the fight. This generalizes to fights that contain 3 or more teams.
    Also add planets if they are involved in the conflict (not necessarily as defenders).
    */
    function advanceFleetBattleOneDay(arrayOfFleets) {

    }

    /*function mergeFleets(fleets) {
      //var thisSector = {position: [d.x, d.y], star: randomStar, planets: [], fleets: []};
      var sectorsByPosition = {};
      var shipsBySector = {};
      for (var i = 0; i < fleets.length; i++) {
        var foundSector = false;
        for (var key in shipsBySector) {
          var dx = fleets.position[0] - key[0];
          var dy = fleets.position[1] - key[1];
          if (fleets.sector.position[0] === key[0] && fleets.sector.position[1] === key[1]) {
            foundSector = true;

            shipsBySector[key].push()
          }
        }

      }
    }*/

    //createFleet(sector, name, position, owner, shipNames)
    /*var fleet = {
      sector: sector,
      position: position,
      owner: owner,
      name: name,
      ships: ships,
      id: theId
    }*/
    function mergeFleet(fleets) {
      if (fleets === null) return;
      if (fleets.length === 0) return;
      var firstSector = fleets[0].sector, firstPosition = fleets[0].position;
      var firstOwner = fleets[0].owner; //, firstName = fleets[0].name;
      var theId = Object.keys(owner.fleets).length;
      var newFleet = {
        sector: fleets[0].sector,
        position: fleets[0].position,
        owner: fleets[0].owner,
        name: fleets[0].name,
        ships: [],
        id: theId
      }
      var shipNames = [];
      for (var i = 0; i < fleets.length; i++) {
        if (fleets[i].sector === firstSector && fleets[i].owner.civId === firstOwner.civId) {
          for (var j = 0; j < fleets[i].ships; j++) {
            newFleet.ships.push(fleets[i].ships[j]);
          }
          removeFleet(fleets[i]);
        }
      }
      owner.fleets["Fleet" + theId] = fleet;
      for (var i = 0; i < fleet.ships.length; i++) {
        fleet.ships[i].owner = owner;
      }
      moveFleet(fleet, firstSector, firstPosition);
    }

    function calcFleetStrength(fleet) {
      var strength = 0;
      for (var i = 0; i < fleet.ships.length; i++) {
        var ship = fleet.ships[i];
        strength += ship.strength;
      }
      return strength;
    }

		var tileStarts = [
      [0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],
			[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],
			[0,0,1,0,0,0],[0,1,0,0,0,0],[1,0,0,0,0,0],[0,0,2,0,0,0],[0,2,0,0,0,0],[2,0,0,0,0,0],[1,1,0,0,0,0],
      [0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1],[0,0,0,2,0,0],[0,0,0,0,2,0],[0,0,0,0,0,2]
		]; //Minerals, Energy, Food, Physics Research, Society Research, Engineering Research
		var tileBiomes = [
			"Volatile",
			"Toxic",
			"Tundra",
			"Desert",
			"Savanna",
			"Grassland",
			"Forest",
			"Rainforest"
		];
		var tileTerrains = [
			"Ocean",
			"Plain",
			"Hill",
			"Mountain"
		];

    function checkIfValidSatellite(planet, satellite, builder) {
      var result = true;
      /*
      if (builder === null) {
        return false;
      }
      */
      if (satellite.biomeRestrict !== null) {
        if (satellite.biomeRestrict === "NotAsteroid") {
          result = result && (planet.biome !== "Asteroid");
        }
      }
      return result;
    }

    function getValidSatellites(planet, builder) {
      var results = [];
      for (var i = 0; i < planetSatellites.length; i++) {
        var satellite = planetSatellites[i];
        if (checkIfValidSatellite(planet, satellite, builder)) {
          results.push(satellite);
        }
      }
      return results;
    }

		function checkIfValidImprovement(tile, impr, builder) {
      if (impr.name === "Colony") {
        return false;
      }
			var result = true;
			if (impr.biomeRestrict !== null) {
				if (impr.biomeRestrict === "Arable") {
					result = result && (tile.localBiome === "Savanna" || tile.localBiome === "Grassland" || tile.localBiome === "Forest" || tile.localBiome === "Rainforest");
				}
        else if (impr.biomeRestrict === "NotToxic") {
          result = result && (tile.localBiome !== "Toxic");
        }
				else {
					result = result && (impr.biomeRestrict === tile.localBiome);
				}
			}
			if (impr.terrainRestrict !== null) {
				if (impr.terrainRestrict === "Land") {
					result = result && (tile.localTerrain !== "Ocean");
				}
				else if (impr.terrainRestrict === "Sea") {
					result = result && (tile.localTerrain === "Ocean");
				}
        else {
					result = result && (impr.terrainRestrict === tile.localTerrain);
				}
			}
      if (impr.buildingRestrict !== null) {
        if (tile.building == null) {
          result = false;
        }
        else {
          result = result && (tile.building.name === impr.buildingRestrict);
        }
      }
      if (builder != null) {
        result = result && (builder.techLevel >= impr.techLevelRestrictMin && builder.techLevel <= impr.techLevelRestrictMax);
      }
			return result;
		}

		function getValidImprovements(tile, builder) {
			var result = [];
			for (var i = 0; i < tileImprovements.length; i++) {
				var impr = tileImprovements[i];
				if (checkIfValidImprovement(tile, impr, builder)) {
					result.push(impr);
				}
			}
			return result;
		}

    function getValidSpaceportQueue(spaceport) {
      var result = [];
      var shipNames = Object.keys(shipTypes);
      for (var i = 0; i < shipNames.length; i++) {
        var ship = shipTypes[shipNames[i]];
        result.push(ship);
      }
      return result;
    }

    function calculateAssignment(tiles, population, weights=[2,1,4,1,1,1]) {
      var scores = {};
      for (var i = 0; i < tiles.length; i++) {
        var res = tiles[i].baseResources;
        scores[i] = 0;
        for (var j = 0; j < res.length; j++) {
          scores[i] += res[j] * weights[j];
        }
        if (tiles[i].building !== null) {
          var out = tiles[i].building.output;
          for (var j = 0; j < out.length; j++) {
            scores[i] += out[j] * weights[j];
          }
        }
      }
      var sorted = Object.keys(scores).sort(function(a, b) {
        return scores[b] - scores[a];
      });
      var result = [];
      for (var i = 0; i < population; i++) {
        result.push(sorted[i]);
      }
      return result;
    }
    function calculateAssignmentPlanet(planet, weights=[2,1,4,1,1,1]) {
      return calculateAssignment(planet.tiles, planet.population, weights);
    }

    function calcTileToBuildOn(tiles, builder, weights=[2,1,4,1,1,1], overwriteBuilding=false) {
      var scores = {};
      for (var i = 0; i < tiles.length; i++) {
        if (!overwriteBuilding && tiles[i].building !== null) {
          scores[i] = -1000;
          continue;
        }
        var validImpr = getValidImprovements(tile, builder);
        if (validImpr.length === 0) {
          scores[i] = -1000;
          continue;
        }
        var res = tiles[i].baseResources;
        scores[i] = 0;
        for (var j = 0; j < res.length; j++) {
          scores[i] += res[j] * weights[j];
        }
      }
      var sorted = d3.entries(scores).sort(function(a, b) { return b.value - a.value; });
      return sorted[0].key;
    }

    function calcImprToBuild(tile, builder, weights=[2,1,4,1,1,1]) {
      var scores = {};
      var validImpr = getValidImprovements(tile, builder);
      if (validImpr.length === 0) return null;
      for (var i = 0; i < validImpr.length; i++) {
        var impr = validImpr[i];
        scores[impr.name] = 0;
        for (var j = 0; j < impr.output.length; j++) {
          scores[impr.name] += impr.output[j] * weights[j];
        }
      }
      var max = d3.entries(scores).sort(function(a, b) { return b.value - a.value; });
      return max[0].key;
    }

    var numStars = 500;
    var numPlanets = 1000;
    var numAsteroids = 2000;

    var sectorRadius = 10;

    var numMajorCivs = 10;
    var numMinorCivs = 0;

    for (var i = 0; i < numStars; i++) {
      //var position = [randomX(), randomY()];
      var star = {
				position: position,
				name: "",
				size: size,
        type: "",
				owner: null
			};
      stars.push(star);
			//stars[position] = star;
    }

    var biomeAbbrs = {};
    biomeAbbrs["Arid"] = "A";
    biomeAbbrs["Icy"] = "I";
    biomeAbbrs["Tundra"] = "Tu";
    biomeAbbrs["Ocean"] = "O";
    biomeAbbrs["Temperate"] = "Te";
    biomeAbbrs["Tropical"] = "Tr";
    biomeAbbrs["Gaia"] = "G";
    biomeAbbrs["Toxic"] = "Tx";
    biomeAbbrs["Ice Cream"] = "IC";
    biomeAbbrs["Barren"] = "B";
    biomeAbbrs["Gas Giant"] = "GG";
    biomeAbbrs["Primordial"] = "P";
    biomeAbbrs["Asteroid"] = "x";

    var biomeDesc = {};
    biomeDesc["Arid"] = "Dry and nearly barren, this planet is harsh for many forms of higher life.";
    biomeDesc["Icy"] = "Cold and frozen over, this planet preserves little life and biodiversity.";
    biomeDesc["Tundra"] = "Mostly grasses and patches of ice, this planet is tough to live off of.";
    biomeDesc["Ocean"] = "This planet has a wet, warm climate and a thick atmosphere which led to the formation of large bodies of water.";
    biomeDesc["Temperate"] = "This planet has seasonal, normal weather supporting a somewhat diverse ecosystem.";
    biomeDesc["Tropical"] = "Hot and humid, this planet is home to all types of life.";
    biomeDesc["Gaia"] = "This planet is a monument and living museum to all the biodiversity imaginable within the universe.";
    biomeDesc["Toxic"] = "Magma flowing in rivers, noxious gases in the air, and jagged, hostile terrain render this planet unbearable and unlivable.";
    biomeDesc["Ice Cream"] = "This planet is very peculiar — the frozen surface preserves a massive sea, almost like a cosmic slushie of water, sugar, and lactating bacteria.";
    biomeDesc["Barren"] = "This planet has no atmosphere and all its life has passed away ages ago.";
    biomeDesc["Gas Giant"] = "This planet is a swirling sphere of gases.";
    biomeDesc["Primordial"] = "This planet is newly formed and still undergoes the stress of its own gravity.";
    biomeDesc["Asteroid"] = "Anywhere from a small piece of space debris to a large space base, this object can only support small satellites.";

    var civTypes = ["Primordial", "Neolithic", "Modern", "Information", "PostInformation", "Transcendent"];
    var civTypeDesc = {};
    civTypeDesc["Primordial"] = "This species has not developed sentience.";
    civTypeDesc["Neolithic"] = "This species has developed agriculture and has formed permanent, social cities.";
    civTypeDesc["Modern"] = "This species has developed some technology and culture but remains relatively unconnected.";
    civTypeDesc["Information"] = "This species has connected itself and run the world with information technology.";
    civTypeDesc["PostInformation"] = "This species has developed viable interstellar space travel.";
    civTypeDesc["Transcendent"] = "This species has exceeded the limit of its purely biological potential and remains stagnant in perfection.";

		for (var i = 0; i < numPlanets + numAsteroids; i++) {
			var size = 0;
			var type = "", typeAbbr = "";
      var habitability = 0;

			var rand = Math.random();

			if (rand < 0.3) {
				size = small();
			}
			else if (rand < 0.7) {
				size = medium();
			}
			else {
				size = large();
			}
			size = Math.round(size);
			if (size > maxTiles) {
				size = maxTiles;
			}

      var baseResources = [];

      if (i < numPlanets) {
  			var rand2 = Math.random();
  			if (rand2 < 1.0/6.0) {
  				type = "Arid";
          typeAbbr = "A";
          habitability = 0.2;
  			} else if (rand2 < 2.0/6.0) {
  				type = "Icy";
          typeAbbr = "I";
          habitability = 0.2;
  			} else if (rand2 < 3.0/6.0) {
  				type = "Tundra";
          typeAbbr = "Tu";
          habitability = 0.4;
  			} else if (rand2 < 4.0/6.0) {
  				type = "Ocean";
          typeAbbr = "O";
          habitability = 0.6;
  			} else if (rand2 < 5.0/6.0) {
  				type = "Temperate";
          typeAbbr = "Te";
          habitability = 1.0;
  			} else if (rand2 < 6.0/6.0) {
  				type = "Tropical";
          typeAbbr = "Tr";
          habitability = 0.6;
  			} else if (rand2 < 7.0/7.0){
  				type = "Toxic";
          typeAbbr = "Tx";
          habitability = 0;
  			} else {

        }
      }
      else {
        type = "Asteroid";
        size = 0;
      }

      var rand3 = Math.random();
      if (rand3 < 0.7) {
        baseResources = [0, 0, 0, 0, 0, 0];
      }
      else if (rand3 < 0.85) {
        var amount = Math.round(Math.random()*4);
        var rand4 = Math.random();
        if (rand4 < 0.33) {
          baseResources = [amount, 0, 0, 0, 0, 0];
        }
        else if (rand4 < 0.66) {
          baseResources = [0, amount, 0, 0, 0, 0];
        }
        else {
          baseResources = [Math.round(amount/2), 0, 0, 0, 0, 0];
        }
      }
      else if (rand3 < 0.90) {
        baseResources = [Math.round(Math.random()*4), Math.round(Math.random()*4), 0, 0, 0, 0];
      }
      else {
        var amount = Math.round(Math.random()*3);
        var rand4 = Math.random(), rand5 = Math.random();
        if (rand4 < 0.33) {
          baseResources = [0, 0, 0, amount, 0, 0];
        }
        else if (rand4 < 0.66) {
          baseResources = [0, 0, 0, 0, amount, 0];
        }
        else {
          baseResources = [0, 0, 0, 0, 0, amount];
        }
        if (rand5 < 0.2) {
          var amount2 = Math.round(Math.random()*2);
          var rand6 = Math.random();
          if (rand6 < 0.33) {
            baseResources[3] += amount2;
          }
          else if (rand6 < 0.66) {
            baseResources[4] += amount2;
          }
          else {
            baseResources[5] += amount2;
          }
        }
      }

			var tiles = [];
			for (var j = 0; j < size; j++) {
				var rand = Math.round(Math.random() * (tileStarts.length - 1));
				var tileStart = tileStarts[rand];
				var biome = Math.round(Math.random() * (tileBiomes.length - 1));
				var terrain = Math.round(Math.random() * (tileTerrains.length - 1));
				//console.log(tileStart);
				var tile = {
					building: null,
					localBiome: tileBiomes[biome],
					localTerrain: tileTerrains[terrain],
          /*
					minerals: tileStart[0],
					energy: tileStart[1],
					food: tileStart[2],
          */
          baseResources: tileStart,
          order: null
				};
				tiles.push(tile);
			}

			var position = [randomX(), randomY()];

			var planet = {
				position: position,
        sector: null,
				name: "",
        star: "",
				size: size,
				biome: type,
        biomeAbbr: typeAbbr,
        habitability: habitability,
				owner: null,
				tiles: tiles,
        tileAssignments: [],
        satelliteBuilding: null,
        population: 0,
				food: 0,
        baseResources: baseResources,
        specialResources: [],
        order: null
			};
			planets[position] = planet;
		}

		for (var i = 0; i < numMajorCivs; i++) {
			var color = d3.scale.linear()
				.domain([0, 20])
				.range(["white", civColors[i % civColors.length]])
				.interpolate(d3.interpolateLab);
      var civType = "PostInformation";
			var civilization = {
				name: "Civilization" + i,
        id: i,
        civType: civType,
        techLevel: 4,
        desc: civTypeDesc[civType],
				color: color,
				worlds: [],
				fleets: {},
			  baseResources: [150, 50, 50, 0, 0, 0]
			};
			civilizations.push(civilization);
		}

    for (var i = 0; i < numMinorCivs; i++) {
      var color = d3.scale.linear()
				.domain([0, 20])
				.range(["white", civColors[i % civColors.length]])
				.interpolate(d3.interpolateLab);
      var techLevel = Math.trunc(Math.random()*4);
      var civType = civTypes[techLevel];
			var civilization = {
				name: "Civilization" + i,
        id: i,
        civType: civType,
        techLevel: techLevel,
        desc: civTypeDesc[civType],
				color: color,
				worlds: [],
				fleets: {},
			  baseResources: [150, 0, 50, 0, 0, 0]
			};
			civilizations.push(civilization);
    }

    //TODO: Add colonization mechanics
    /*
    Add civilizations ranging from primordial, to neolithic, to industrial, and name the post-information nations and make them unique.
    Make colonizable planets more unique and rare and valuable
    Add interactions between civilizations including attitudes, treatments, and combat

    Also add technologies to game and research point resources
    */

		var planetPositions = Object.keys(planets);
    for (var i = 0; i < civilizations.length; i++) {
      var randPlanet = null, planet = null;
      while (true) {
        randPlanet = Math.round(d3.randomUniform(0, planetPositions.length - 1)());
        planet = planets[planetPositions[randPlanet]];
        if (planet.size > 14) {
          break;
        }
      }
      civilizations[i].worlds.push(planet);
      planet.owner = civilizations[i];
      if (civilizations[i].civType === "PostInformation") {
        planet.population = 7;
        var spaceport = planetSatellites[0];
        planet.satelliteBuilding = jQuery.extend({}, spaceport);
        planet.satelliteBuilding.planet = planet;
        buildImprOnTileByName(planet.position, Math.trunc(Math.random()*planet.size), "Colony");
        for (var j = 0; j < 5; j++) {
          var tileIndex = calcTileToBuildOn(planet.tiles, planet.owner);
          var tile = planet.tiles[tileIndex];
          var imprName = calcImprToBuild(tile, planet.owner);
          if (imprName !== null) {
            buildImprOnTileByName(planet.position, tileIndex, imprName);
          }
        }
      }
      else {
        planet.population = 4;
        if (civilizations[i].civType === "Neolithic" || civilizations[i].civType === "Modern" || civilizations[i].civType === "Information") {
          buildImprOnTileByName(planet.position, Math.trunc(Math.random()*planet.size), "Primitive City");
          for (var j = 0; j < 3; j++) {
            buildImprOnTileByName(planet.position, Math.trunc(Math.random()*planet.size), "Primitive Farm");
          }
        }
      }
      //moveFleet(fleet, destSector, destPosition);
    }
    /*
		for (var i = 0; i < numPlanets + numAsteroids; i++) {
			var randPlanet = Math.round(d3.randomUniform(0, planetPositions.length - 1)());
			var randCiv = Math.round(d3.randomUniform(0, civilizations.length - 1)());
      //var planet = planets[planetPositions[randPlanet]];
      var planet = planets[planetPositions[i]];
      if (planet.biome === "Asteroid") {
        planet.owner = null;
        planet.population = 0;
      }
      else {
        if (Math.random() < 0.1) {
          civilizations[randCiv].worlds.push(planet);
    			planet.owner = civilizations[randCiv];
          planet.population = 3;
          var spaceport = planetSatellites[0];
          planet.satelliteBuilding = jQuery.extend({}, spaceport);
          planet.satelliteBuilding.planet = planet;
          buildImprOnTileByName(planet.position, Math.trunc(Math.random()*planet.size), "Colony");
          //moveFleet(fleet, destSector, destPosition);
        }
      }
      //planets[planetPositions[i]].owner = civilizations[randCiv];
		}*/

		var color = d3.scale.linear()
				.domain([0, 20])
				.range(["white", "white"])
				.interpolate(d3.interpolateLab);

		var hexbin = d3.hexbin()
				.size([width, height])
				.radius(sectorRadius);

		var x = d3.scale.identity()
				.domain([0, width]);

		var y = d3.scale.linear()
				.domain([0, height])
				.range([height, 0]);

		var planetTooltip = d3.select("#planet-tooltip");
		var planetTooltipHeader = d3.select("#planet-tooltip-header");

    var systemTooltip = d3.select("#system-tooltip-main");
    var systemTooltipHeader = d3.select("#system-tooltip-header");
    var systemStarMap = d3.select("#system-tooltip-starmap");
    var systemTooltipVisible = false;

    var fleetTooltip = d3.select("#fleet-tooltip-main");
    var fleetTooltipVisible = false, planetTooltipVisible = false;

    var planetBuildTooltip = d3.select("#planet-build-main");
    var spaceportBuildTooltip = d3.select("#spaceport-build-main");
    var satelliteBuildTooltip = d3.select("#satellite-build-main");

    var timeTooltip = d3.select("#player-hud-time");

    var foodNeededToGrow = 50;

		function hideTooltip() {
			planetTooltip.transition()
				.duration(200)
				.style("opacity", 0);
			//planetTooltip.style("left", "0px")
				//.style("top", "2000px");
      systemTooltip.transition()
        .duration(200)
        .style("opacity", 0);
      fleetTooltip.transition()
        .duration(200)
        .style("opacity", 0);
      planetTooltip.style("pointer-events", "none");
      systemTooltip.style("pointer-events", "none");
      fleetTooltip.style("pointer-events", "none");

      systemTooltipVisible = false;
      planetTooltipVisible = false;
      fleetTooltipVisible = false;

      //var buildMenu = d3.select("#planet-build-main");
      planetBuildTooltip.style("pointer-events", "none");
      planetBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);

      spaceportBuildTooltip.style("pointer-events", "none");
      spaceportBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);

      satelliteBuildTooltip.style("pointer-events", "none");
      satelliteBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);

      currentPlanetSelected = null;
      currentFleetSelected = null;
      currentSectorSelected = null;
      currentSpaceportSelected = null;
		}

    var starMapSvg = systemStarMap.append("svg")
        .attr("width", $("#system-tooltip-starmap").width)
        .attr("height", $("#system-tooltip-starmap").height)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		var svg = d3.select("body").append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
			.append("g")
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		svg.append("clipPath")
				.attr("id", "clip")
			.append("rect")
				.attr("class", "mesh")
				.attr("width", width)
				.attr("height", height);

    var usedStars = {};

    var starMapCircleMarkers = [];

    var blackColor = d3.scale.linear()
        .domain([0, 20])
        .range(["white", "black"])
        .interpolate(d3.interpolateLab);
		svg.append("g")
				.attr("clip-path", "url(#clip)")
			.selectAll(".hexagon")
				.data(hexbin(planets))
			.enter().append("path")
				.attr("class", "hexagon")
				.attr("d", hexbin.hexagon())
				.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
				.style("fill", function(d) {
					var returnColor = null;
          //console.log("-----");
          var index = Math.round(Math.random()*(stars.length - 1));
          /*while (true) {
            index = Math.round(Math.random()*(stars.length - 1));
            if (usedStars[index] == false) {
              usedStars[index] = true;
              break;
            }
          }*/

          var randomStar = stars[index];
          var thisSector = {position: [d.x, d.y], posX: d.x, posY: d.y, star: randomStar, planets: [], fleets: [], neighborPositions: []};
					d.forEach(function(element) {
						//console.log(planets[element]);
            //console.log(element);
            thisSector.planets.push(element);
						var planet = planets[element];
            planet.sector = thisSector;
						if (planet.owner === null) {

						}
						else {
              if (returnColor === null) { //No other civs have been found in this system
                returnColor = planet.owner.color(d.length);
              }
              else { //The system is contested
                returnColor = blackColor(10);
              }
						}
					});
          sectors[[d.x, d.y]] = thisSector;
          if (returnColor === null) {
            returnColor = color(5);
          }
					return returnColor;
				}).on("click", function(d) {
					d3.event.preventDefault();

          //console.log("click " + systemTooltipVisible);

          if (currentFleetSelected !== null) {
            queueShipOrdersToSector(currentFleetSelected, sectors[[d.x, d.y]]);
            displayFleet(currentFleetSelected);
            return;
          }

          systemTooltipVisible = !systemTooltipVisible;
          if (!systemTooltipVisible) { //Close the tooltip if it's open, don't open another tooltip for another system
            hideTooltip();
            return;
          }

          var sector = sectors[[d.x, d.y]];
          currentSectorSelected = sector;

          planetTooltip.style("pointer-events", "none");
          systemTooltip.style("pointer-events", "auto");

          displaySector(sector);

				}).on("contextmenu", function(data, index) {
					d3.event.preventDefault();
					hideTooltip();
				}).on("mouseover", function() {

				});

    systemStarMap.on("click", function() {
      d3.event.preventDefault();
      d3.event.stopPropagation();
    });

    systemStarMap.on("contextmenu", function() {
      d3.event.preventDefault();

      var click = d3.mouse(this);
      var width = $("#system-tooltip-starmap").width();
      var height = $("#system-tooltip-main").height()*0.8;

      //console.log(click + " " + $("#system-tooltip-starmap").width() + " " + ($("#system-tooltip-main").height()*0.8));
      if (currentFleetSelected !== null) { //Selected fleet can do an action on the planet like building a new satellite
        d3.event.stopPropagation(); //Do not click the body. Events propagate up the hierachy.
        var temp = d3.event.target;

        //console.log(temp);
        //console.log(temp.dataset["planetposition"]);

        var percentX = click[0] / width * 2 - 1;
        var percentY = click[1] / height * 2 - 1;
        //console.log(percentX + " " + percentY);
        var destSector = currentSectorSelected;
        var newPosition = [destSector.position[0] + sectorRadius * percentX, destSector.position[1] + sectorRadius * percentY];

        var noActionsFound = false;
        if (temp.src.includes("planet_")) { //Also includes asteroids
          var actions = [];
          for (var i = 0; i < fleet.ships.length; i++) {
            if (fleet.ships[i].action !== null) {
              actions.push(fleet.ships[i].action);
            }
          }
          if (actions.length > 0) {
            var trueX = click[0] / width;
            var trueY = click[1] / height;
            var actionsTooltip = d3.select("#system-action-menu");
            actionsTooltip.transition()
              .duration(200)
              .style("opacity", .9)
              .style("pointer-events", "auto");
            actionsTooltip.html("")
              .style("left", Math.round(trueX*100) + "%")
              .style("top", Math.round(trueY*100) + "%");
            var menuString = "";
            for (var i = 0; i < actions.length; i++) {
              menuString += "<p>" +
              "<button type=\"button\" class=\"tile-build-button\" " +
              "onclick=\"javascript:requestActionOnPlanet([" + temp.dataset["planetposition"] + "], " + currentFleetSelected.id + ", &quot;" + actions[i] + "&quot;); " +
              "javascript:hideActionMenu(); " +
              "javascript:displayPlanetFromCoord([" + temp.dataset["planetposition"] + "]); \"" +
              "style=\"max-height:50px; max-width:300px; width:100%; position:relative; z-index:" + i + ";\">" + actions[i] + "</button>" +
              "</p>";
            }
            actionsTooltip.html(menuString);
          }
          else {
            noActionsFound = true;
          }
        }
        if (!temp.src.includes("planet_") || noActionsFound) {
          if (currentFleetSelected.sector === currentSectorSelected) {
            //console.log("Success");
            //Move a ship within the same sector by an order
            var order = {
              orderType: "MoveWithinSector",
              fleet: currentFleetSelected,
              destination: newPosition,
              desc: "Cruise in " + destSector.star.name
            };
            currentFleetSelected.orders = [order];
            moveWithinSectorOrders.push(currentFleetSelected);
          }
          else {
            //Create an order to move a ship from its sector to the current sector selected
            //Move the same ship within the sector through an order as above
            queueShipOrdersToSector(currentFleetSelected, currentSectorSelected, newPosition);
          }
        }

        displayFleet(currentFleetSelected);
      }
    });

    systemTooltip.on("click", function() {
      d3.event.preventDefault();
    });

    d3.select("#system-tooltip-main").on("click", function() {
      d3.event.preventDefault();
    });

		d3.select("body").style("background-color", "#326EFF");

    d3.select("body").on("contextmenu", function() {
			d3.event.preventDefault();
      console.log("yes");
			hideTooltip();
		});

    fleetTooltip.on("contextmenu", function() {
      d3.event.preventDefault();
      fleetTooltip.transition()
        .duration(200)
        .style("opacity", 0);
      fleetTooltip.style("pointer-events", "none");
      fleetTooltipVisible = false;
    });

    /*
    var xSet = new Set(), ySet = new Set();
    var minX = 0, maxX = 0, minY = 0, maxY = 0;
    for (var key in sectors) {
      //console.log(key);
      var rawPos = sectors[key].position;
      var pos = [Math.trunc(rawPos[0]), Math.trunc(rawPos[1])];
      if (minX === 0 && minY === 0) {
        minX = pos[0]; maxX = pos[0];
        minY = pos[1]; maxY = pos[1];
        continue;
      }
      xSet.add(pos[0]); //ySet.add(pos[1]);
      if (pos[0] < minX) minX = pos[0];
      else if (pos[0] > maxX) maxX = pos[0];
      if (pos[1] < minY) minY = pos[1];
      else if (pos[1] > maxY) maxY = pos[1];
    }
    var temp = Array.from(xSet).sort();
    console.log(temp);
    */
    //console.log(minX + " " + maxX);

    //An O(N^2) squared method but it can be applied and generalized to any shape
    for (var pos in sectors) {
      var thisSector = sectors[pos];
      for (var pos2 in sectors) {
        if (pos == pos2) continue;
        //console.log(">>>>" + typeof pos + " " + typeof pos2);
        //pos = pos.split(",");
        //pos2 = pos2.split(",");
        /*var split = pos.split(",");
        var split2 = pos2.split(",");
        var dx = (+split[0]) - (+split2[0]), dy = (+split[1]) - (+split2[1]);*/
        var otherSector = sectors[pos2];
        var dx = thisSector.posX - otherSector.posX, dy = thisSector.posY - otherSector.posY;
        var dist = Math.sqrt(dx*dx + dy*dy);
        //console.log(split + " " + split2 + " " + dx + " " + dy + " " + dist);
        if (dist < 20) {
          thisSector.neighborPositions.push(pos2);
          //console.log("Success: " + dx + " " + dy + " " + dist);
        }
      }
    }

    //for (var pos in sectors) {
      //console.log(sectors[pos].neighborPositions.length);
    //}

    function displaySector(sector) {
      while (starMapCircleMarkers.length > 0) {
        var circle = starMapCircleMarkers.pop();
        circle.remove();
      }
      /*planetTooltip.transition()
        .duration(200)
        .style("opacity", 0.9);*/
      systemTooltip.transition()
        .duration(200)
        .style("opacity", 0.9);
      //planetTooltip.style("left", (d3.event.pageX) + "px")
        //.style("top", (d3.event.pageY - 28) + "px");
      planetTooltip.style("left", "10%")
        .style("top", "25%");
      systemTooltip.style("left", "50%")
        .style("top", "25%");
      d3.select("#tutorial").transition()
        .duration(200)
        .style("opacity", 0.0);

      systemTooltipHeader.html("<h3>" + sector.star.name + " - Class " + sector.star.type + "&emsp;" +
      "<img src=\""+sector.star.type.toUpperCase()+"_Star.png\" alt=\"Star\" align=\"center\" style=\"max-height:40px; max-width:40px; width:100%\"/>&emsp;" +
      "<button type=\"button\" onclick=\"javascript:hideSystemMap();\">Close System Map</button>" +
      "</h3>");

      //var rect = systemStarMap.getBoundingClientRect();
      //console.log(rect.top, rect.right, rect.bottom, rect.left);

      var starMapWidth = $("#system-tooltip-main").width();
      var starMapHeight = $("#system-tooltip-main").height();
      systemStarMap.html(
        "<img src=\"./blank.png\" alt=\"Planet\" width=\"50\" height=\"50\" align=\"center\" " +
        "style=\"left:0%; top:0%; max-height:" + starMapHeight + "px; max-width:" + starMapWidth + "px; width:100%; height:100%; position:absolute; z-index:-1;\" />"
      );
      for (var planetPos in sector.planets) {
        var planet = planets[sector.planets[planetPos]];
        var dx = planet.position[0] - sector.position[0];
        var dy = planet.position[1] - sector.position[1];
        //console.log(dx/10 + " " + dy/10);
        //console.log(starMapWidth + " " + starMapHeight);
        var trueX = Math.round((dx/10 + 1.0) / 2.0 * 100);
        var trueY = Math.round((dy/10 + 1.0) / 2.0 * 100);
        var sizePlanet = 15 + Math.round(planet.size / maxTiles * 25);
        if (planet.biome === "Asteroid") {
          sizePlanet = 15;
        }
        var textOffsetX = starMapWidth*(trueX/100) - 80;
        var textOffsetY = starMapHeight*(trueY/100) + sizePlanet;

        var resourceString = "<p>";
        if (planet.baseResources[0] > 0) {
          resourceString += planet.baseResources[0] + "&nbsp;<img src=\"./minerals.png\" alt=\"Minerals\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;"
        }
        if (planet.baseResources[1] > 0) {
          resourceString += planet.baseResources[1] + "&nbsp;<img src=\"./energy.png\" alt=\"Energy\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
        }
        if (planet.baseResources[2] > 0) {
          resourceString += planet.baseResources[2] + "&nbsp;<img src=\"./food.png\" alt=\"Planets\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
        }
        if (planet.baseResources[3] > 0) {
          resourceString += planet.baseResources[3] + "&nbsp;<img src=\"./star_research.png\" alt=\"Star Research\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;"
        }
        if (planet.baseResources[4] > 0) {
          resourceString += planet.baseResources[4] + "&nbsp;<img src=\"./society_research.png\" alt=\"Society Research\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;"
        }
        if (planet.baseResources[5] > 0) {
          resourceString += planet.baseResources[5] + "&nbsp;<img src=\"./production_research.png\" alt=\"Production Research\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;"
        }
        resourceString += "</p>"
        if (resourceString === "<p></p>") resourceString = "";
        var planetInfoString = planet.name;
        if (planet.biome !== "Asteroid") {
          planetInfoString += " (" + planet.biomeAbbr + ", " + planet.size + ")";
        }
        else {
          planetInfoString = "";
        }

        systemStarMap.html(
          systemStarMap.html() +
          //"<figure class=\"tint\" style=\"background: rgba(0, 0, 255, 0.5);\">" +
          "<img src=\"./planet_" + planet.biome.toLowerCase() + ".png\" data-planetposition=\"" + planet.position + "\" alt=\"Planet\" width=\"50\" height=\"50\" align=\"center\" " +
          "onclick=\"javascript:displayPlanetFromCoord([" + planet.position[0] + "," + planet.position[1] + "]); " +
          "javascript:hideBuildMenu(); \" " +
          "style=\"left:" + trueX + "%; top:" + trueY + "%; max-height:" + sizePlanet + "px; max-width:" + sizePlanet + "px; width:100%; position:absolute; z-index:-1;\" />" +
          //"</figure>" +
          "<div style=\"left:" + textOffsetX + "px; top:" + textOffsetY + "px; max-height:200px; max-width:200px; width:100%; pointer-events:none; position:absolute; z-index:-1;\">" +
          planetInfoString + resourceString +
          "</div>"
        );
        var circle = starMapSvg.append("circle").attr({
                      cx: starMapWidth*(trueX/100),
                      cy: starMapHeight*(trueY/100),
                      r: 30,
                      fill: "none",
                      stroke: "black"
                    });
        starMapCircleMarkers.push(circle);
      }
      for (var i = 0; i < sector.fleets.length; i++) {
        var fleet = sector.fleets[i];
        var dx = fleet.position[0] - sector.position[0];
        var dy = fleet.position[1] - sector.position[1];
        //console.log(dx/10 + " " + dy/10);
        //console.log(starMapWidth + " " + starMapHeight);
        var trueX = Math.round((dx/10 + 1.0) / 2.0 * 100);
        var trueY = Math.round((dy/10 + 1.0) / 2.0 * 100);

        var textOffsetX = starMapWidth*(trueX/100) - 20;
        var textOffsetY = starMapHeight*(trueY/100) - 10;

        //console.log(trueX + " " + trueY);
        var strength = calcFleetStrength(fleet);

      // displayFleet(civId, fleetId)
        systemStarMap.html(
          systemStarMap.html() +
          "<img src=\"./red_ship.png\" alt=\"Fleet\" width=\"50\" height=\"50\" align=\"center\" " +
          "onclick=\"javascript:displayFleetFromId(" + fleet.owner.id + "," + fleet.id + ");\" " +
          "style=\"left:" + trueX + "%; top:" + trueY + "%; max-height:20px; max-width:20px; width:100%; position:absolute; z-index:" + i + ";\" />" +
          "<div style=\"left:" + textOffsetX + "px; top:" + textOffsetY + "px; max-height:20px; max-width:100px; width:100%; pointer-events:none; position:absolute; z-index:" + i + ";\">" +
          strength +
          "<img src=\"./strength.png\" alt=\"Fleet\" width=\"50\" height=\"50\" align=\"center\" " +
          "style=\"max-height:10px; max-width:10px; width:100%; pointer-events:none; position:relative; z-index:" + i + ";\" />" + "&nbsp;" +
          fleet.ships.length +
          "<img src=\"./ship.png\" alt=\"Fleet\" width=\"50\" height=\"50\" align=\"center\" " +
          "style=\"max-height:10px; max-width:10px; width:100%; pointer-events:none; position:relative; z-index:" + i + ";\" />" +
          "</div>"
        );
      }
    }

    function displaySatelliteBuildMenuFromCoord(planetPosition) {
      var planet = planets[planetPosition];
      displaySatelliteBuildMenu(planet);
    }

    function displaySatelliteBuildMenu(planet) {
      satelliteBuildTooltip.style("pointer-events", "auto");
      satelliteBuildTooltip.transition()
        .duration(200)
        .style("opacity", 1);

      spaceportBuildTooltip.style("pointer-events", "none");
      spaceportBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);

      planetBuildTooltip.style("pointer-events", "none");
      planetBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);

      var validSate = getValidSatellites(planet, planet.owner);

      satelliteBuildTooltip.html("<h4>Build Satellite</h4>");
      //{name: "Mine", output: [1,0,0], cost: [70,0,0], maintenance: [0,-1,0], biomeRestrict: null, terrainRestrict: "Land"}
      //{name: "Spaceport", planet: null, output: [0,0,0,1,1,1], buildTime: 400, cost: [250,0,0,0,0,0], maintenance: [0,-3,-2,0,0,0], biomeRestrict: "NotAsteroid", starRestrict: null, orders: []},
      for (var i = 0; i < validSate.length; i++) {
        var impr = validSate[i];

        var satelliteString = "";
        if (impr.output[0] > 0) satelliteString += impr.output[0] + "<img src=\"./minerals.png\" alt=\"Minerals\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
        if (impr.output[1] > 0) satelliteString += impr.output[1] + "<img src=\"./energy.png\" alt=\"Energy\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
        if (impr.output[2] > 0) satelliteString += impr.output[2] + "<img src=\"./food.png\" alt=\"Planets\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
        if (impr.output[3] > 0) satelliteString += impr.output[3] + "<img src=\"./star_research.png\" alt=\"Minerals\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
        if (impr.output[4] > 0) satelliteString += impr.output[4] + "<img src=\"./society_research.png\" alt=\"Energy\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
        if (impr.output[5] > 0) satelliteString += impr.output[5] + "<img src=\"./production_research.png\" alt=\"Planets\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
        satelliteString += impr.buildTime + "<img src=\"./time.png\" alt=\"Planets\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>";

        satelliteBuildTooltip.html(satelliteBuildTooltip.html() +
          "<div>" +
          "<button type=\"button\" class=\"tile-build-button\" onclick=\"javascript:requestQueueSatelliteOnPlanet([" + planet.position[0] + "," + planet.position[1] + "], &quot;" + impr.name + "&quot;); " +
          "javascript:hideBuildSatelliteMenu(); " +
          "javascript:displayPlanetFromCoord([" + planet.position[0] + "," + planet.position[1] + "]); \"" +
          "style=\"max-height:50px; max-width:300px; width:100%; position:relative; z-index:" + i + ";\">" + impr.name + "</button>" +
          "<p>" + satelliteString + "</p>" +
          "</div>"
        );
      }
    }

    function displaySpaceportBuildMenuFromCoord(planetPosition) {
      var planet = planets[planetPosition];
      var port = planet.satelliteBuilding;
      if (port === null) {
        hideTooltip();
        return;
      }

      displaySpaceportBuildMenu(port);
    }

    function displaySpaceportBuildMenu(port) {
      var planetPosition = port.planet.position;
      currentSpaceportSelected = port;

      spaceportBuildTooltip.style("pointer-events", "auto");
      spaceportBuildTooltip.transition()
        .duration(200)
        .style("opacity", 1);

      planetBuildTooltip.style("pointer-events", "none");
      planetBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);

      satelliteBuildTooltip.style("pointer-events", "none");
      satelliteBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);

      var validQueue = getValidSpaceportQueue(port);
      spaceportBuildTooltip.html("<h4>Spaceport Queue</h4>");
      for (var i = 0; i < port.orders.length; i++) {
        var order = port.orders[i];
        spaceportBuildTooltip.html(spaceportBuildTooltip.html() +
        "<h5>" +
        "Queue: " + order.unit.name + ", " +
        order.timeRemaining + "&nbsp;<img src=\"./time.png\" alt=\"Time\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>" +
        "</h5>");
      }
      //{name: "Mine", output: [1,0,0], cost: [70,0,0], maintenance: [0,-1,0], biomeRestrict: null, terrainRestrict: "Land"}
      //<button type="button" class="button" onclick="alert('Hello world!')">Click Me!</button>
      for (var i = 0; i < validQueue.length; i++) {
        var impr = validQueue[i];
        spaceportBuildTooltip.html(spaceportBuildTooltip.html() +
          "<p>" +
          "<button type=\"button\" class=\"tile-build-button\" onclick=\"javascript:requestQueueUnitOnTile([" + planetPosition[0] + "," + planetPosition[1] + "], &quot;" + impr.name + "&quot;, " + port.planet.owner.id +"); " +
          "javascript:hideSpaceportMenu(); " +
          "javascript:displayPlanetFromCoord([" + planetPosition[0] + "," + planetPosition[1] + "]); \"" +
          "style=\"max-height:50px; max-width:300px; width:100%; position:relative; z-index:" + i + ";\">" + impr.name + "</button>" +
          "</p>"
        );
      }
    }

    function displayTileBuildMenu(planetPosition, tileNum) {
      var planet = planets[planetPosition];
      var tile = planet.tiles[tileNum];
      //var buildMenu = d3.select("#planet-build-main");
      planetBuildTooltip.style("pointer-events", "auto");
      planetBuildTooltip.transition()
        .duration(200)
        .style("opacity", 1);

      spaceportBuildTooltip.style("pointer-events", "none");
      spaceportBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);

      satelliteBuildTooltip.style("pointer-events", "none");
      satelliteBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);

      if (planet.owner !== null) {
        var validImprovements = getValidImprovements(tile, planet.owner);
        planetBuildTooltip.html("<h4>Build Improvement</h4>");
        //{name: "Mine", output: [1,0,0], cost: [70,0,0], maintenance: [0,-1,0], biomeRestrict: null, terrainRestrict: "Land"}
        //<button type="button" class="button" onclick="alert('Hello world!')">Click Me!</button>
        for (var i = 0; i < validImprovements.length; i++) {
          var impr = validImprovements[i];
          planetBuildTooltip.html(planetBuildTooltip.html() +
            "<p>" +
            "<button type=\"button\" class=\"tile-build-button\" onclick=\"javascript:requestQueueImprOnTile([" + planetPosition[0] + "," + planetPosition[1] + "], " + tileNum + ", &quot;" + impr.name + "&quot;, " + planet.owner.id +"); " +
            "javascript:hideBuildMenu(); " +
            "javascript:displayPlanetFromCoord([" + planetPosition[0] + "," + planetPosition[1] + "]); \"" +
            "style=\"max-height:50px; max-width:300px; width:100%; position:relative; z-index:" + i + ";\">" + impr.name + "</button>" +
            "</p>"
          );
        }
      }
      else {
        planetBuildTooltip.html("<h4>Uncolonized (Cannot Build)</h4>");
      }
    }

    function hideFleetTooltip() {
      //var fleetTooltip = d3.select("#fleet-tooltip-main");
      fleetTooltip.style("pointer-events", "none");
      fleetTooltip.transition()
        .duration(200)
        .style("opacity", 0);
    }

    function hideSpaceportMenu() {
      spaceportBuildTooltip.style("pointer-events", "none");
      spaceportBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);
    }

    function hideBuildMenu() {
      planetBuildTooltip.style("pointer-events", "none");
      planetBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);
    }

    function hideBuildSatelliteMenu() {
      satelliteBuildTooltip.style("pointer-events", "none");
      satelliteBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);
    }

    function hideSystemMap() {
      systemTooltip.style("pointer-events", "none");
      systemTooltip.transition()
        .duration(200)
        .style("opacity", 0);
      planetTooltip.style("pointer-events", "none");
      planetTooltip.transition()
        .duration(200)
        .style("opacity", 0);
      currentSectorSelected = null;
      currentPlanetSelected = null;
      systemTooltipVisible = false;
    }

    //requestActionOnPlanet([" + temp.dataset["planetposition"] + "], " + currentFleetSelected.id + ", &quot;" + actions[i] + "&quot;); " +
    function requestActionOnPlanet(planetPosition, fleetId, actionString) {
      var planet = planets[position];
      var fleet = fleets["Fleet" + fleetId];
      if (actionString === "Colonize") {

      }
      else if (actionString === "Explore") {

      }
      else if (actionString === "Build") {

      }
      else {
        
      }
    }

    function requestQueueSatelliteOnPlanet(planetPosition, satelliteName, ownerId) {
      //var planet = planets[planetPosition];
      var satellite = null;
      for (var i = 0; i < planetSatellites.length; i++) {
        if (planetSatellites[i].name === satelliteName) {
          satellite = planetSatellites[i];
        }
      }
      if (satellite === null) {
        var cost = satellite.cost;
        var owner = civilizations[ownerId];
        var civRes = owner.baseResources;
        for (var i = 0; i < cost.length; i++) {
          if (cost[i] > civRes[i]) {
            //Not enough resources to build the improvement
            return;
          }
        }
        for (var i = 0; i < cost.length; i++) {
          civRes[i] -= cost[i];
        }
        queueSatelliteOnPlanet(planetPosition, satellite);
      }
    }

    function queueSatelliteOnPlanet(planetPosition, satellite) {
      var planet = planets[planetPosition];
      var order = {
        orderType: "buildSatellite",
        timeRemaining: satellite.buildTime,
        owner: planet.owner,
        planetPosition: planetPosition,
        satellite: satellite
      };
      planet.order = order;
      satelliteOrders.push(order);
    }

    function buildSatelliteOnPlanet(planetPosition, satellite) {
      var planet = planets[planetPosition];
      planet.satelliteBuilding = {name: satellite.name, output: satellite.output, maintenance: satellite.maintenance};
      planet.order = null;
    }

    function requestQueueUnitOnTile(planetPosition, shipName, ownerId) {
      var impr = shipTypes[shipName];
      if (impr !== null) {
        var cost = impr.cost;
        var owner = civilizations[ownerId];
        var civRes = owner.baseResources;
        for (var i = 0; i < cost.length; i++) {
          if (cost[i] > civRes[i]) {
            //Not enough resources to build the improvement
            return;
          }
        }
        for (var i = 0; i < cost.length; i++) {
          civRes[i] -= cost[i];
        }
        queueUnitOrderOnPosition(planetPosition, impr, owner);
        //buildImprOnTile(planetPosition, tileNum, impr);
      }
    }

    function queueUnitOrderOnPosition(planetPosition, unit, owner) {
      var spaceport = planets[planetPosition].satelliteBuilding;
      var order = {
        orderType: "buildUnit",
        timeRemaining: unit.buildTime,
        owner: owner,
        planetPosition: planetPosition,
        spaceport: spaceport,
        unit: unit
      };
      spaceport.orders.push(order);
      unitOrders.push(order);
    }

    function bulidUnitOnSpaceport(owner, planetPosition, spaceport, unit) {
      var planet = planets[planetPosition];
      if (unit !== null) {
        var fleet = createFleet(planet.sector, planet.name + " Fleet", planetPosition, owner, [unit.name]);
      }
      spaceport.orders.splice(0, 1);
    }

    function requestQueueImprOnTile(planetPosition, tileNum, imprName, ownerId) {
      var impr = null;
      for (var i = 0; i < tileImprovements.length; i++) {
        if (tileImprovements[i].name === imprName) {
          impr = tileImprovements[i];
        }
      }
      if (impr !== null) {
        var cost = impr.cost;
        var owner = civilizations[ownerId];
        var civRes = owner.baseResources;
        for (var i = 0; i < cost.length; i++) {
          if (cost[i] > civRes[i]) {
            //Not enough resources to build the improvement
            return;
          }
        }
        for (var i = 0; i < cost.length; i++) {
          civRes[i] -= cost[i];
        }
        queueImprOrderOnTile(planetPosition, tileNum, impr);
        //buildImprOnTile(planetPosition, tileNum, impr);
      }
    }

    function queueImprOrderOnTile(planetPosition, tileNum, impr) {
      var order = {
        orderType: "buildTileImpr",
        timeRemaining: impr.buildTime,
        planetPosition: planetPosition,
        tileNum: tileNum,
        impr: impr
      };
      var tile = planets[planetPosition].tiles[tileNum];
      tile.order = order;
      constructionOrders.push(order);
    }

    function buildImprOnTile(planetPosition, tileNum, impr) {
      if (impr !== null) {
        var tile = planets[planetPosition].tiles[tileNum];
        tile.order = null;
        tile.building = {name: impr.name, output: impr.output, maintenance: impr.maintenance};
      }
    }

    function buildImprOnTileByName(planetPosition, tileNum, imprName) {
      var impr = null;
      for (var i = 0; i < tileImprovements.length; i++) {
        if (tileImprovements[i].name === imprName) {
          impr = tileImprovements[i];
        }
      }
      buildImprOnTile(planetPosition, tileNum, impr);
    }

    function queueShipOrdersToSector(fleet, destSector, newPosition=null) {
      fleet.orders = [];
      if (newPosition === null) {
        newPosition = fleet.position;
      }
      var path = aStarSearch(fleet.sector, destSector);
      if (path === null) return;
      for (var i = 0; i < path.length; i++) {
        var order = {
          orderType: "MoveToSector",
          fleet: currentFleetSelected,
          destSector: path[i],
          destination: path[i].position,
          desc: "Move to " + destSector.star.name
        };
        fleet.orders.push(order);
      }
      if (moveToSectorOrders.indexOf(fleet) === -1) {
        moveToSectorOrders.push(fleet);
      }
    }
    /*function queueFleetOrder(fleet, positionInSameSector) {
      var order = {
        orderType: "moveFleetInSector",
        fleet: fleet,
        destination: positionInSameSector
      };
      moveWithinSectorOrders.push(order);
    }*/

    function defaultEuclideanHeuristic(inspectSector, destSector) {
      var dx = inspectSector.position[0] - destSector.position[0];
      var dy = inspectSector.position[1] - destSector.position[1];
      return Math.sqrt(dx*dx + dy*dy) / 20;
    }

    /*
    Given a query [startSector, endSector], with function heuristic(inspect, goal),
    where the optimal path is [startSector, sector1, sector2, ..., sectorN, endSector],
    and the nodes are expanded with lowest priority first (priority = total cost + heuristic cost),
    return [sector1, sector2, ..., sectorN, endSector].
    */
    function aStarSearch(startSector, endSector, heuristic=defaultEuclideanHeuristic) {
      if (startSector == endSector) return [];

      var closedPositions = new Set();
      var fringe = [];
      fringe.push([startSector, [], 0, 0]);

      while (true) {
        if (fringe.length === 0) {
          //console.log("Path not found");
          return null;
        }
        var node = null, minIndex = 0, minCost = 0;
        for (var i = 0; i < fringe.length; i++) {
          if (fringe[i][3] < minCost || node === null) {
            node = fringe[i];
            minIndex = i;
            minCost = fringe[i][3];
          }
        }
        fringe.splice(minIndex, 1);
        if (endSector === node[0]) {
          //node[1].push(endSector);
          //console.log(startSector.position + " " + endSector.position);
          //console.log(node[1]);
          return node[1];
        }
        if (!closedPositions.has(node[0].position)) {
          closedPositions.add(node[0].position);
          for (var i = 0; i < node[0].neighborPositions.length; i++) {
            var successor = sectors[node[0].neighborPositions[i]];
            var newList = node[1].slice(0);
            newList.push(successor);
            fringe.push([successor, newList, node[2] + 1, node[2] + 1 + heuristic(successor, endSector)]);
          }
        }
      }

      return null;
    }

    function displayFleetFromId(civId, fleetId) {
      //console.log(civId + " " + fleetId + " " + civilizations[civId] + " " + civilizations[civId].fleets[fleetId]);
      var fleet = civilizations[civId].fleets["Fleet" + fleetId];
      displayFleet(fleet);
    }

    function displayFleet(fleet) {
      currentFleetSelected = fleet;
      if (fleet === null) {
        hideTooltip();
      }
      else {
        fleetTooltip.transition()
          .duration(200)
          .style("opacity", 1);
        fleetTooltip.style("pointer-events", "auto");
        fleetTooltipVisible = true;
        if (planetTooltipVisible) {
          planetTooltipVisible = false;
          planetTooltip.transition()
            .duration(200)
            .style("opacity", 0);
          planetTooltip.style("pointer-events", "none");
          currentPlanetSelected = null;
          currentSpaceportSelected = null;
        }
      }

      var fleetStrength = calcFleetStrength(fleet);
      var fleetStringy = "<h4>" + fleet.name + "&emsp;" +
      fleetStrength + "&nbsp;" +
      "<img src=\"./strength.png\" alt=\"Fleet\" width=\"50\" height=\"50\" align=\"center\" " +
      "style=\"max-height:20px; max-width:20px; width:100%; pointer-events:none; position:relative; z-index:" + i + ";\" />" + "&nbsp;&nbsp;" +
      fleet.ships.length + "&nbsp;" +
      "<img src=\"./ship.png\" alt=\"Fleet\" width=\"50\" height=\"50\" align=\"center\" " +
      "style=\"max-height:20px; max-width:20px; width:100%; pointer-events:none; position:relative; z-index:" + i + ";\" />"
      + "</h4>";
      if (fleet.orders.length === 0) {
        fleetStringy += "<p>Idle</p>";
      }
      else {
        var firstOrder = fleet.orders[0];
        fleetStringy += "<p>";
        fleetStringy += firstOrder.desc;
        if (fleet.orders.length > 1) {
          fleetStringy += "&nbsp;(" + (fleet.orders.length - 1) + " more";
          if (fleet.orders.length === 2) {
            fleetStringy += " order)";
          }
          else {
            fleetStringy += " orders)";
          }
        }
        fleetStringy += "</p>";
      }
      fleetTooltip.html(fleetStringy);
      for (var i = 0; i < fleet.ships.length; i++) {
        var ship = fleet.ships[i];
        //var health = Math.ceil(ship.health / ship.maxHealth * 100);
        fleetTooltip.html(
          fleetTooltip.html() + "<p>" + ship.name + "&emsp;" +
          ship.strength + "&nbsp;" +
          "<img src=\"./strength.png\" alt=\"Fleet\" width=\"50\" height=\"50\" align=\"center\" " +
          "style=\"max-height:20px; max-width:20px; width:100%; pointer-events:none; position:relative; z-index:" + i + ";\" />" + "&nbsp;&nbsp;" +
          ship.health + "/" + ship.maxHealth + "&nbsp;" +
          "<img src=\"./health.png\" alt=\"Fleet\" width=\"50\" height=\"50\" align=\"center\" " +
          "style=\"max-height:20px; max-width:20px; width:100%; pointer-events:none; position:relative; z-index:" + i + ";\" />" +
          "</p>"
        );
      }
    }

    function displayPlanetFromCoord(position) {
      //console.log(position);
      var planet = planets[position];
      //console.log(planet);
      displayPlanet(planet);
    }

    function displayPlanet(planetClicked) {
      currentPlanetSelected = planetClicked;
      d3.select("#system-tutorial").transition()
				.duration(200)
				.style("opacity", 0);
      if (planetClicked === null) {
        hideTooltip();
      }
      else {
        planetTooltip.transition()
          .duration(200)
          .style("opacity", 0.9);
        planetTooltip.style("pointer-events", "auto");
        planetTooltipVisible = true;
        if (fleetTooltipVisible) {
          fleetTooltipVisible = false;
          fleetTooltip.transition()
            .duration(200)
            .style("opacity", 0);
          fleetTooltip.style("pointer-events", "none");
          currentFleetSelected = null;
          currentSpaceportSelected = null;
        }
      }

      var planetString = "";
      var total = [];
      for (var k = 0; k < planetClicked.baseResources.length; k++) {
        total.push(planetClicked.baseResources[k]);
      }
      if (planetClicked.satelliteBuilding !== null) {
        for (var k = 0; k < planetClicked.baseResources.length; k++) {
          total[k] += planetClicked.satelliteBuilding.output[k];
        }
      }
      if (total[0] > 0) planetString += total[0] + "&nbsp;<img src=\"./minerals.png\" alt=\"Minerals\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
      if (total[1] > 0) planetString += total[1] + "&nbsp;<img src=\"./energy.png\" alt=\"Energy\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
      if (total[2] > 0) planetString += total[2] + "&nbsp;<img src=\"./food.png\" alt=\"Planets\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
      if (total[3] > 0) planetString += total[3] + "&nbsp;<img src=\"./star_research.png\" alt=\"Minerals\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
      if (total[4] > 0) planetString += total[4] + "&nbsp;<img src=\"./society_research.png\" alt=\"Energy\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
      if (total[5] > 0) planetString += total[5] + "&nbsp;<img src=\"./production_research.png\" alt=\"Planets\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";

      var planetSize = Math.round(planetClicked.size / maxTiles * 50 + 25);
      var currentText = "";
      if (planetClicked.biome !== "Asteroid") {
        currentText = "<h3>" + planetClicked.name + "</h3><h4>" + planetClicked.biome + ", " + planetClicked.size + ", " + Math.round(planetClicked.habitability*100) + "% habitability&nbsp;&nbsp;" + planetString + "</h4>" +
          "<p><img src=\"./planet_" + planetClicked.biome.toLowerCase() + ".png\" alt=\"Planet\" width=\"" + planetSize + "\" height=\"" + planetSize + "\" style=\"max-height:" + planetSize + "px; max-width:" + planetSize + "px; width:100%;\"/></p>";
      }
      else {
        currentText = "<h3>" + planetClicked.name + "</h3><h4>" + planetClicked.biome + "&nbsp;&nbsp;" + planetString + "</h4>" +
          "<p><img src=\"./planet_" + planetClicked.biome.toLowerCase() + ".png\" alt=\"Planet\" width=\"30\" height=\"30\" style=\"max-height:30px; max-width:30px; width:100%;\"/></p>";
      }

      if (planetClicked.owner === null) {
        currentText += "<h4>Uncolonized";
      }
      else {
        currentText += "<h4>" + planetClicked.owner.name + ", " +
        planetClicked.population + "<img src=\"./population.png\" alt=\"Population\" width=\"20\" height=\"20\" style=\"max-height:20px; max-width:20px; width:100%;\"/>, " +
        planetClicked.food + "/" + foodNeededToGrow + "&nbsp;<img src=\"./food.png\" alt=\"Planets\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>";
      }
      if (planetClicked.satelliteBuilding === null) {
        if (planetClicked.order === null) {
          currentText += ", No Satellite&nbsp;"
        }
        else {
          currentText += ", Building&nbsp;" + planetClicked.order.satellite.name + "&nbsp;" + planetClicked.order.timeRemaining + "&nbsp;<img src=\"./time.png\" alt=\"Planets\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>"
        }
        currentText += "&nbsp;" +
        "<img src=\"build-icon.png\" alt=\"Build\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\" "+
        "onclick=\"javascript:displaySatelliteBuildMenuFromCoord([" + planetClicked.position[0] + "," + planetClicked.position[1] + "]);\" " +
        "/>" +
        "</h4>";
      }
      else {
        currentText += ", " + planetClicked.satelliteBuilding.name + "&nbsp;" +
        "<img src=\"build-icon.png\" alt=\"Build\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\" "+
        "onclick=\"javascript:displaySatelliteBuildMenuFromCoord([" + planetClicked.position[0] + "," + planetClicked.position[1] + "]);\" " +
        "/>";
        if (planetClicked.satelliteBuilding.name === "Spaceport") {
          var port = planetClicked.satelliteBuilding;
          if (port.orders.length > 0) {
            var order = port.orders[0];
            currentText +=
              "&nbsp;(" + order.unit.name + ", " +
              order.timeRemaining + "<img src=\"./time.png\" alt=\"Time\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>";
            if (port.orders.length != 1) {
              currentText += ", +" + (port.orders.length - 1) + " more";
            }
            currentText += ")";
          }
          currentText += "&nbsp;<img src=\"hammer.png\" alt=\"Produce\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\" "+
          "onclick=\"javascript:displaySpaceportBuildMenuFromCoord([" + planetClicked.position[0] + "," + planetClicked.position[1] + "]);\" " +
          "/>";
          if (planetClicked.order !== null) {

          }
        }
        currentText += "</h4>";
      }

      currentText += "<p>" + biomeDesc[planetClicked.biome] + "</p>";

      planetTooltipHeader.html(currentText);
      //console.log(planetClicked.tiles.length);

      var assignment = calculateAssignmentPlanet(planetClicked);

      for (var j = 0; j < maxTiles; j++) {
        var planetTooltipTile = d3.select("#planet-tooltip-tile" + j);
        if (j < planetClicked.tiles.length) {
          //planetTooltipTile.html("<p>Test"+j+"<img src=\"./minerals.png\"></img></p>");
          var tile = planetClicked.tiles[j];
          var tileResourceString = "";
          //var minerals = tile.baseResources[0], energy = tile.baseResources[1], food = tile.baseResources[2];
          var total = [];
          for (var k = 0; k < tile.baseResources.length; k++) {
            total.push(tile.baseResources[k]);
          }
          if (tile.building !== null) {
            for (var k = 0; k < tile.baseResources.length; k++) {
              total[k] += tile.building.output[k];
            }
          }
          if (total[0] > 0) {
            tileResourceString += total[0] + "<img src=\"./minerals.png\" alt=\"Minerals\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&emsp;";
          }
          if (total[1] > 0) {
            tileResourceString += total[1] + "<img src=\"./energy.png\" alt=\"Energy\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&emsp;";
          }
          if (total[2] > 0) {
            tileResourceString += total[2] + "<img src=\"./food.png\" alt=\"Planets\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&emsp;";
          }
          if (total[3] > 0) {
            tileResourceString += total[3] + "<img src=\"./star_research.png\" alt=\"Minerals\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&emsp;";
          }
          if (total[4] > 0) {
            tileResourceString += total[4] + "<img src=\"./society_research.png\" alt=\"Energy\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&emsp;";
          }
          if (total[5] > 0) {
            tileResourceString += total[5] + "<img src=\"./production_research.png\" alt=\"Planets\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>";
          }
          var tileInfo = "" +
            "<p>" +
            tileResourceString +
            "</p>" +
            "<p>" +
            tile.localBiome + ", " + tile.localTerrain + " " +
            "<img src=\"build-icon.png\" alt=\"Build\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\" "+
            "onclick=\"javascript:displayTileBuildMenu([" + planetClicked.position[0] + "," + planetClicked.position[1] + "], " + j + ")\" " +
            "/>";
          if (assignment.indexOf(j + "") !== -1) {
            tileInfo += "<img src=\"./population.png\" alt=\"Worker\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\" "+
              "onclick=\" \" " +
              "/>" +
              "</p>";
          }
          else {
            tileInfo += "</p>";
          }
          planetTooltipTile.html(tileInfo);
          if (tile.order !== null) {
            planetTooltipTile.html(planetTooltipTile.html() +
              "<p>Build: " + tile.order.impr.name + ", " +
              tile.order.timeRemaining + "&nbsp;<img src=\"./time.png\" alt=\"Time\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>" +
              "</p>");
          }
          else if (tile.building === null) {
            //planetTooltipTile.html(planetTooltipTile.html() + "<p>-</p>");
          }
          else {
            planetTooltipTile.html(planetTooltipTile.html() +
              "<p>" + tile.building.name + "</p>");
          }
        }
        else {
          planetTooltipTile.html("");
        }
      }
      if (planetClicked.owner !== null) {
        var assignment = calculateAssignmentPlanet(planetClicked);
        for (var j = 0; j < maxTiles; j++) {
          var planetTooltipTile = d3.select("#planet-tooltip-tile" + j);
          if (assignment.indexOf(j + "") !== -1) {
            planetTooltipTile.style("border", "1px solid red");
          }
          else {
            planetTooltipTile.style("border", "none");
          }
        }
      }
      else {
        for (var j = 0; j < maxTiles; j++) {
          var planetTooltipTile = d3.select("#planet-tooltip-tile" + j);
          planetTooltipTile.style("border", "none");
        }
      }
    }

		function namePlanets() {
			for (var key in planets) {
				var planet = planets[key];
        if (planet.biome === "Asteroid") {
  				var randPlanet = Math.round(Math.random()*(planetData.length - 1));
  				planet.name = planetData[randPlanet]["pl_hostname"] + " " + planetData[randPlanet]["pl_letter"];
        }
			}
			/*for (var key in planets) {
				var planet = planets[key];
				console.log(planet.name);
			}*/
		}

    function nameStars() {
			for (var key in stars) {
				var star = stars[key];
				var randStar = Math.round(Math.random()*(starData.length - 1));
        var displayName = starData[randStar]["Display Name"];
        var displayName2 = starData[randStar]["BayerFlamsteed"];
        if (displayName === displayName2) {
          star.name = starData[randStar]["Display Name"];
        }
        else {
  				star.name = starData[randStar]["Display Name"] + " " + starData[randStar]["BayerFlamsteed"];
        }
        star.type = starData[randStar]["Star Type"];
        //console.log(">>>" + star.type);
			}
			/*for (var key in planets) {
				var planet = planets[key];
				console.log(planet.name);
			}*/
		}

    function nameAsteroids() {
      for (var key in planets) {
        var planet = planets[key];
        if (planet.biome !== "Asteroid") {
          var randPlanet = Math.round(Math.random()*(smallBodyData.length - 1));
          planet.name = smallBodyData[randPlanet]["name"].trim();
        }
      }
    }

    //Ships need to be evaluated every frame to have a relatively smooth animation
    function evaluateShips() {
      var speedMod = 0;
      if (gameMode === "Paused") {
        return;
      }
      else if (gameMode === "Slow") speedMod = 0.25;
      else if (gameMode === "Fast") speedMod = 0.5;
      else if (gameMode === "Fastest") speedMod = 1;
      //TODO: Combine moveWithinSectorOrders and moveToSectorOrders and determine which order by the orderType property
      //All ships with any orders should be in this list and removed when there are no orders of any type left.
      for (var i = moveWithinSectorOrders.length - 1; i >= 0; i--) {
        var fleet = moveWithinSectorOrders[i];
        var finalSpeed = fleet.speed*speedMod/2;
        if (fleet.orders.length <= 0) {
          moveWithinSectorOrders.splice(i, 1);
          continue;
        }
        var order = fleet.orders[0];
        //TODO: Move fleet linearly towards its destination
        var shipPos = fleet.position, shipDes = order.destination;
        var dir = [shipDes[0] - shipPos[0], shipDes[1] - shipPos[1]];
        var len = Math.sqrt(dir[0]*dir[0] + dir[1]*dir[1]);
        if (len <= finalSpeed) {
          fleet.position = shipDes;
          fleet.orders.splice(0, 1);
          continue;
        }
        dir[0] /= len; dir[1] /= len;
        fleet.position = [shipPos[0] + finalSpeed*dir[0], shipPos[1] + finalSpeed*dir[1]];
      }
      for (var i = moveToSectorOrders.length - 1; i >= 0; i--) {
        var fleet = moveToSectorOrders[i];
        var canFtlTravel = true;
        for (var j = 0; j < fleet.ships.length; j++) {
          var ship = fleet.ships[i];
          if (ship.ftl !== ship.maxFtl || ship.maxFtl === 0) {
            canFtlTravel = false;
            break;
          }
        }
        if (fleet.orders.length > 0) {
          var firstOrder = fleet.orders[0];
          if (canFtlTravel && firstOrder.orderType === "MoveToSector") {
            moveFleet(fleet, destSector, destPosition)
            moveFleet(fleet, firstOrder.destSector, firstOrder.destination);
            for (var j = 0; j < fleet.ships.length; j++) {
              var ship = fleet.ships[i];
              ship.ftl = 0;
            }
            shipRecoverFTL.push(fleet);
          }
        }
      }
    }

    function updateRender() {
      if (currentSpaceportSelected !== null) {
        displaySpaceportBuildMenu(currentSpaceportSelected);
      }
      if (currentPlanetSelected !== null) {
        displayPlanet(currentPlanetSelected);
      }
      if (currentFleetSelected !== null) {
        displayFleet(currentFleetSelected);
      }
      if (currentSectorSelected !== null) {
        //TODO: Display updated sector
        displaySector(currentSectorSelected);
      }
    }

    function evaluateDay() {
      //Move all fleets towards destination
      //Evaluate battles and other actions like excavations
      //Evaluate construction progress and create new buildings when done
      for (var i = constructionOrders.length - 1; i >= 0; i--) {
        var order = constructionOrders[i];
        order.timeRemaining--;
        if (order.timeRemaining <= 0) {
          buildImprOnTile(order.planetPosition, order.tileNum, order.impr);
          constructionOrders.splice(i, 1);
        }
      }
      for (var i = unitOrders.length - 1; i >= 0; i--) {
        var order = unitOrders[i];
        order.timeRemaining--;
        if (order.timeRemaining <= 0) {
          //TODO: Create new fleet, merge if another fleet nearby
          bulidUnitOnSpaceport(order.owner, order.planetPosition, order.spaceport, order.unit);
          unitOrders.splice(i, 1);
        }
      }
      for (var i = satelliteOrders.length - 1; i >= 0; i--) {
        var order = satelliteOrders[i];
        order.timeRemaining--;
        if (order.timeRemaining <= 0) {
          buildSatelliteOnPlanet(order.planetPosition, order.satellite);
          satelliteOrders.splice(i, 1);
        }
      }

      for (var i = shipRecoverFTL.length - 1; i >= 0; i--) {
        var fleet = shipRecoverFTL[i];
        var needsToRecover = false;
        for (var j = 0; j < fleet.ships.length; j++) {
          var ship = fleet.ships[j];
          if (ship.ftl < ship.maxFtl) {
            ship.ftl++;
          }
          if (ship.ftl >= ship.maxFtl) {
            ship.ftl = ship.maxFtl;
          }
          else {
            needsToRecover = true;
          }
        }
        if (!needsToRecover) {
          shipRecoverFTL.splice(i, 1);
        }
      }
      updateRender();
    }

    function evaluateMonth() {
      //Evaluate tech progress
      for (var key in planets) {
        var planet = planets[key];
        if (planet.owner !== null) {
          planet.tileAssignments = calculateAssignmentPlanet(planet);
          //var sumMinerals = 0, sumEnergy = 0, sumFood = 0;
          var sumYield = [0,0,0,0,0,0];
          //var maintMinerals = 0, maintEnergy = 0, maintFood = 0;
          var sumMaint = [0,0,0,0,0,0];
          //TODO: Factor in resource to this, generalize with a loop
          for (var i = 0; i < planet.tileAssignments.length; i++) {
            var tile = planet.tiles[planet.tileAssignments[i]];
            for (var j = 0; j < tile.baseResources.length; j++) {
              sumYield[j] += tile.baseResources[j];
            }
            if (tile.building !== null) {
              for (var j = 0; j < tile.building.output.length; j++) {
                sumYield[j] += tile.building.output[j];
                sumMaint[j] += tile.building.maintenance[j];
              }
            }
          }
          planet.owner.baseResources[0] += sumYield[0] - sumMaint[0];
          planet.owner.baseResources[1] += sumYield[1] - sumMaint[1];

          planet.owner.baseResources[3] += sumYield[3] - sumMaint[3];
          planet.owner.baseResources[4] += sumYield[4] - sumMaint[4];
          planet.owner.baseResources[5] += sumYield[5] - sumMaint[5];
          /*
          sumMinerals *= planet.habitability;
          sumEnergy *= planet.habitability;
          */

          //console.log(sumMinerals + " " + sumEnergy + " " + sumFood);
          sumFood = sumFood - (planet.population * 1 + maintFood);
          planet.food += sumFood;
          if (planet.food > foodNeededToGrow) {
            planet.population++;
            planet.food = Math.round(planet.food / 4);
          }
          //console.log(sumMinerals + " " + sumEnergy + " " + sumFood);
        }
      }
    }

    for (var i = 0; i < civilizations.length; i++) {
      var civ = civilizations[i];
      if (civ.techLevel >= 4) {
        for (var j = 0; j < civilizations[i].worlds.length; j++) {
          var world = civilizations[i].worlds[j];
          var fleet = createFleet(world.sector, world.name + " Fleet", world.position, civilizations[i], ["Destroyer", "Destroyer", "Destroyer", "Constructor"]);
        }
      }
    }

    /*function requestFullScreen(element) {
        // Supports most browsers and their versions.
        var requestMethod = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || element.msRequestFullScreen;

        if (requestMethod) { // Native full screen.
            requestMethod.call(element);
        } else if (typeof window.ActiveXObject !== "undefined") { // Older IE.
            var wscript = new ActiveXObject("WScript.Shell");
            if (wscript !== null) {
                wscript.SendKeys("{F11}");
            }
        }
    }

    var elem = document.body; // Make the body go full screen.
    requestFullScreen(elem);*/

    function displayTime() {
      timeTooltip.html(
        currentDate.getFullYear() + "." +
        (currentDate.getMonth() + 1) + "." +
        currentDate.getDate() + "&emsp;" +
        gameMode
      );
    }

    function setGameSpeed(newMode) {
      gameMode = newMode;
      displayTime();
    }

    window.addEventListener("resize", updateRender);

    var timer = d3.interval(function(elapsed) {
      var advanceDay = false;
      evaluateShips();
      if (frames === 0) {
        //advanceDay = true;
        displayTime();
      }
      frames++;
      if (frames >= 8) {
        frames = 0;
      }
      if (gameMode === "Paused") {

      }
      else if (gameMode === "Slow") {
        if (frames % 8 == 0) {
          advanceDay = true;
        }
      }
      else if (gameMode === "Fast") {
        if (frames % 4 == 0) {
          advanceDay = true;
        }
      }
      else if (gameMode === "Fastest") {
        if (frames % 2 == 0) {
          advanceDay = true;
        }
      }
      if (advanceDay) {
        var currentMonth = currentDate.getMonth();
        currentDate.setDate(currentDate.getDate() + 1);
        var newMonth = currentDate.getMonth();
        if (currentMonth !== newMonth) {
          //Advance a month
          evaluateMonth();
        }
        //console.log(currentDate);

        days++;
        if (days >= 365) {
          days = 0;
        }
        evaluateDay();
      }
      displayTime();
    }, 250, 0);

		</script>

  </body>
</html>
